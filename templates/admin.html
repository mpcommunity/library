<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <title>Ù…Ø¯ÛŒØ±ÛŒØª Ú©ØªØ§Ø¨â€ŒÙ‡Ø§</title>
  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/font-face.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    body {
      font-family: 'Vazir', sans-serif;
      direction: rtl;
      background: linear-gradient(to right, #fff3e0, #e0f7fa);
      padding: 40px;
      margin: 0;
      text-align: center;
    }

    h1 {
      color: #2e7d32;
      margin-bottom: 30px;
    }

    .btn {
      background: #00796b;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      margin: 5px;
    }

    .btn:hover {
      background: #004d40;
    }

    .content-box {
      display: none;
      max-width: 600px;
      margin: 0 auto;
      background: #ffffffdd;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      text-align: right;
    }

    input[type="text"],
    input[type="file"],
    input[type="password"] {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 16px;
    }

    ul {
      list-style: none;
      padding: 0;
      margin-top: 20px;
    }

    li {
      background: #f1f8e9;
      margin: 6px 0;
      padding: 10px 14px;
      border-radius: 6px;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .book-title {
      flex-grow: 1;
      margin-right: 10px;
    }

    .section-title {
      margin-top: 20px;
      color: #00796b;
      font-size: 18px;
    }

    #bookSuggestions {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      max-height: 150px;
      overflow-y: auto;
      margin-top: -10px;
      margin-bottom: 10px;
    }

    #bookSuggestions li {
      padding: 8px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }

    #bookSuggestions li:hover {
      background: #e0f2f1;
    }

    .edit-box {
      display: none;
      background: #fff;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      margin-top: 10px;
      width: 100%;
    }

    .user-menu {
      position: absolute;
      top: 20px;
      left: 20px;
      text-align: left;
    }

    .menu-box {
      display: none;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <h1>ØµÙØ­Ù‡ Ù…Ø¯ÛŒØ±ÛŒØª Ú©ØªØ§Ø¨â€ŒÙ‡Ø§</h1>

  <div class="user-menu">
    <button class="btn" onclick="toggleUserMenu()">ğŸ‘¤ {{ name }}</button>
    <div id="userMenu" class="menu-box">
      <button class="btn" onclick="showPasswordBox()">ğŸ”’ ØªØºÛŒÛŒØ± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</button>
      <button class="btn" onclick="goBack()">ğŸšª Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>

  <button class="btn" onclick="toggleContent('bookContent')">Ø§ÙØ²ÙˆØ¯Ù† / Ø¨Ø±Ø±Ø³ÛŒ Ú©ØªØ§Ø¨â€ŒÙ‡Ø§</button>
  <div id="bookContent" class="content-box">
    <div class="section-title">â• Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú©ØªØ§Ø¨ Ø¬Ø¯ÛŒØ¯</div>
    <input type="text" id="bookInput" placeholder="Ù†Ø§Ù… Ú©ØªØ§Ø¨ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
    <button class="btn" onclick="addBook()">Ø«Ø¨Øª Ú©ØªØ§Ø¨</button>

    <div class="section-title">ğŸ“¤ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„</div>
    <form action="/upload" method="POST" enctype="multipart/form-data">
      <input type="file" name="file" accept=".xlsx">
      <button class="btn" type="submit">Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ§ÛŒÙ„</button>
    </form>

    <div class="section-title">ğŸ“š Ù„ÛŒØ³Øª Ú©ØªØ§Ø¨â€ŒÙ‡Ø§ÛŒ Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡</div>
    <ul id="bookList"></ul>
  </div>

  <button class="btn" onclick="toggleContent('loanContent')">Ø§ÙØ²ÙˆØ¯Ù† / Ø¨Ø±Ø±Ø³ÛŒ Ø§ÙØ±Ø§Ø¯ Ù‚Ø±Ø¶â€ŒÚ¯ÛŒØ±Ù†Ø¯Ù‡</button>
  <div id="loanContent" class="content-box">
    <div class="section-title">ğŸ“¥ Ø«Ø¨Øª Ø§Ù…Ø§Ù†Øª</div>
    <input type="text" id="borrowerInput" placeholder="Ù†Ø§Ù… ÙØ±Ø¯ Ù‚Ø±Ø¶â€ŒÚ¯ÛŒØ±Ù†Ø¯Ù‡">
    <input type="text" id="bookSearch" placeholder="Ù†Ø§Ù… Ú©ØªØ§Ø¨ (Ø¬Ø³ØªØ¬Ùˆ Ø§Ø² Ù„ÛŒØ³Øª)" oninput="filterBooks()">
    <ul id="bookSuggestions"></ul>
    <input type="text" id="returnDate" placeholder="ØªØ§Ø±ÛŒØ® ØªØ­ÙˆÛŒÙ„">
    <button class="btn" onclick="submitLoan()">Ø«Ø¨Øª Ø§Ù…Ø§Ù†Øª</button>

    <div class="section-title">ğŸ‘¥ Ø§ÙØ±Ø§Ø¯ Ù‚Ø±Ø¶â€ŒÚ¯ÛŒØ±Ù†Ø¯Ù‡â€ŒÛŒ ÙØ¹Ù„ÛŒ</div>
    <ul id="loanList"></ul>
  </div>

  <div id="passwordBox" class="content-box">
    <div class="section-title">ğŸ”’ ØªØºÛŒÛŒØ± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</div>
    <input type="password" id="oldPass" placeholder="Ø±Ù…Ø² ÙØ¹Ù„ÛŒ">
    <input type="password" id="newPass" placeholder="Ø±Ù…Ø² Ø¬Ø¯ÛŒØ¯">
    <button class="btn" onclick="submitPassword()">Ø«Ø¨Øª ØªØºÛŒÛŒØ±</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    let books = [];

    function toggleContent(id) {
      const box = document.getElementById(id);
      box.style.display = box.style.display === "none" || box.style.display === "" ? "block" : "none";
    }

    function toggleUserMenu() {
      const menu = document.getElementById("userMenu");
      menu.style.display = menu.style.display === "none" ? "block" : "none";
    }

    function showPasswordBox() {
      document.getElementById("passwordBox").style.display = "block";
      document.getElementById("userMenu").style.display = "none";
    }

    async function submitPassword() {
      const old = document.getElementById("oldPass").value;
      const newP = document.getElementById("newPass").value;

      const res = await fetch("/change-password", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ old, new: newP })
      });

      const result = await res.json();
      alert(result.message || result.error);
      if (result.message) {
        document.getElementById("passwordBox").style.display = "none";
        document.getElementById("oldPass").value = "";
        document.getElementById("newPass").value = "";
      }
    }

    async function addBook() {
      const title = document.getElementById("bookInput").value.trim();
      if (!title) return;

      await fetch("/api/books", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ title })
      });

      document.getElementById("bookInput").value = "";
      loadBooks();
    }

    async function loadBooks() {
      const res = await fetch("/api/books");
      books = await res.json();
      const bookList = document.getElementById("bookList");
      bookList.innerHTML = "";

      books.forEach(b => {
        const li = document.createElement("li");

        const span = document.createElement("span");
        span.textContent = b.title;
        span.className = "book-title";

        const editBtn = document.createElement("button");
        editBtn.textContent = "âœï¸";
        editBtn.className = "btn";
        editBtn.onclick = () => editBook(b.id, b.title);

        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "ğŸ—‘ï¸";
        deleteBtn.className = "btn";
        deleteBtn.onclick = () => deleteBook(b.id);

        li.appendChild(span);
        li.appendChild(editBtn);
        li.appendChild(deleteBtn);
        bookList.appendChild(li);
      });
    }

    function filterBooks() {
      const input = document.getElementById("bookSearch").value.toLowerCase();
      const suggestionBox = document.getElementById("bookSuggestions");
      suggestionBox.innerHTML = "";

      if (!input) return;

      const matches = books.filter(b => b.title.toLowerCase().includes(input));
      matches.forEach(b => {
        const li = document.createElement("li");
        li.textContent = b.title;
        li.onclick = () => {
          document.getElementById("bookSearch").value = b.title;
          suggestionBox.innerHTML = "";
        };
        suggestionBox.appendChild(li);
      });
    }

    async function submitLoan() {
      const borrower = document.getElementById("borrowerInput").value.trim();
      const bookTitle = document.getElementById("bookSearch").value.trim();
      const returnDate = document.getElementById("returnDate").value;

      if (!borrower || !bookTitle || !returnDate) {
        alert("Ù‡Ù…Ù‡â€ŒÛŒ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø§Ù„Ø²Ø§Ù…ÛŒ Ù‡Ø³ØªÙ†Ø¯");
        return;
      }

      const valid = books.some(b => b.title === bookTitle);
      if (!valid) {
        alert("Ú©ØªØ§Ø¨ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª. Ù„Ø·ÙØ§Ù‹ Ø§Ø² Ù„ÛŒØ³Øª Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.");
        return;
      }

      await fetch("/api/loans", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ borrower, book_title: bookTitle, return_date: returnDate })
      });

      document.getElementById("borrowerInput").value = "";
      document.getElementById("bookSearch").value = "";
      document.getElementById("returnDate").value = "";
      document.getElementById("bookSuggestions").innerHTML = "";
      loadLoans();
    }

    async function loadLoans() {
      const res = await fetch("/api/loans");
      const loans = await res.json();
      const loanList = document.getElementById("loanList");
      loanList.innerHTML = "";

      loans.forEach(l => {
        const li = document.createElement("li");

        const span = document.createElement("span");
        span.textContent = `${l.borrower} - ${l.book_title} - ${l.return_date}`;
        span.className = "book-title";

        const returnBtn = document.createElement("button");
        returnBtn.textContent = "âœ… ØªØ­ÙˆÛŒÙ„ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯";
        returnBtn.className = "btn";
        returnBtn.onclick = () => {
          const confirmReturn = confirm("Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù†ÛŒ Ú©Ù‡ Ø§ÛŒÙ† Ú©ØªØ§Ø¨ ØªØ­ÙˆÛŒÙ„ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡ØŸ");
          if (!confirmReturn) return;
          fetch(`/api/loans/${l.id}`, { method: "DELETE" }).then(() => loadLoans());
        };

        const editBtn = document.createElement("button");
        editBtn.textContent = "âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´";
        editBtn.className = "btn";
        editBtn.onclick = () => showEditBox(l);

        li.appendChild(span);
        li.appendChild(returnBtn);
        li.appendChild(editBtn);
        loanList.appendChild(li);
      });
    }

    function showEditBox(loan) {
      const box = document.createElement("div");
      box.className = "edit-box";

      const nameInput = document.createElement("input");
      nameInput.value = loan.borrower;

      const bookInput = document.createElement("input");
      bookInput.value = loan.book_title;

      const dateInput = document.createElement("input");
      dateInput.value = loan.return_date;
      flatpickr(dateInput, { dateFormat: "Y-m-d" });

      const saveBtn = document.createElement("button");
      saveBtn.textContent = "ğŸ’¾ Ø«Ø¨Øª";
      saveBtn.className = "btn";
      saveBtn.onclick = () => {
        const updated = {
          borrower: nameInput.value.trim(),
          book_title: bookInput.value.trim(),
          return_date: dateInput.value
        };
        fetch(`/api/loans/${loan.id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(updated)
        }).then(() => {
          box.remove();
          loadLoans();
        });
      };

      box.appendChild(nameInput);
      box.appendChild(bookInput);
      box.appendChild(dateInput);
      box.appendChild(saveBtn);

      const parentLi = [...document.querySelectorAll("#loanList li")].find(li =>
        li.textContent.includes(loan.borrower) && li.textContent.includes(loan.book_title)
      );
      parentLi.appendChild(box);
      box.style.display = "block";
    }

    function goBack() {
      window.location.href = "/logout";
    }

    flatpickr("#returnDate", { dateFormat: "Y-m-d" });

    loadBooks();
    loadLoans();
  </script>
</body>
</html>
